<span style="color:#000000">01</span>

# 第1章  绪论

本章对嵌入式系统进行了概述，介绍了嵌入式系统的组成、实时操作系统、嵌入式系统的软件、嵌入式系统的分类、嵌入式系统的应用领域、嵌入式系统的体系、嵌入式系统的设计方法和嵌入式系统的发展。

# 1.1 嵌入式系统

国际电气和电子工程师协会（IEEE）定义的嵌入式系统（Embedded Systems）是“用于控制、监视或者辅助操作机器和设备运行的装置”（原文为devices used to control， monitor， or assist the operation of equipment， machinery or plants）。这主要是从应用上加以定义的，从中可以看出嵌入式系统是软件和硬件的综合体，还可以涵盖机械等附属装置。

国内普遍认同的嵌入式系统定义是，以计算机技术为基础，以应用为中心，软件、硬件可剪裁，适合应用系统对功能可靠性、成本、体积、功耗严格要求的专业计算机系统。

在构成上，嵌入式系统以微控制器及软件为核心部件，两者缺一不可；在特征上，嵌入式系统具有方便、灵活地嵌入到其他应用系统的特征，即具有很强的可嵌入性。

按嵌入式微控制器类型划分，嵌入式系统可分为以单片机为核心的嵌入式单片机系统、以工业计算机板为核心的嵌入式计算机系统、以DSP为核心组成的嵌入式数字信号处理器系统、以FPGA为核心的嵌入式SOPC（System on a Programmable Chip，可编程片上系统）等。

嵌入式系统在含义上与传统的单片机系统和计算机系统有很多重叠部分。为了方便区分，在实际应用中，嵌入式系统还应该具备下述三个特征。

1）嵌入式系统的微控制器通常是由32位及以上的RISC（Reduced Instruction Set Computer，精简指令集计算机）处理器组成的。

2）嵌入式系统的软件系统通常是以嵌入式操作系统为核心，外加用户应用程序。

3）嵌入式系统在特征上具有明显的可嵌入性。

嵌入式系统应用经历了无操作系统、单操作系统、实时操作系统和面向 Intemet 四个阶段。21世纪无疑是一个网络的时代，互联网的快速发展及广泛应用为嵌入式系统的发展及应用提供了良好的机遇。“人工智能”这一热词一夜之间人尽皆知。而嵌入式在其发展过程中扮演着重要角色。

# 1.1.1 嵌入式系统概述

嵌入式系统的发展大致经历了以下三个阶段。

（1）以嵌入式微控制器为基础的初级嵌入式系统。

（2）以嵌入式操作系统为基础的中级嵌入式系统。

（3）以Internet和RTOS为基础的高级嵌入式系统。

嵌入式计算机则是以嵌入式系统的形式隐藏在各种装置、产品和系统中。在许多应用领域，如工业控制、智能仪器仪表、家用电器、电子通信设备等，对嵌入式计算机的应用有着不同的要求。

主要要求如下：

1）能面对控制对象，例如面对物理量传感器的信号输入，面对人机交互的操作控制，面对对象的伺服驱动和控制。

2）可嵌入到应用系统。由于体积小，低功耗，价格低廉，可方便地嵌入到应用系统和电子产品中。

3）能在工业现场环境中长时间可靠运行。

4）控制功能优良。对外部的各种模拟和数字信号能及时地捕捉，对多种不同的控制对象能灵活地进行实时控制。

# 1.1.2 嵌入式系统和通用计算机系统比较

作为计算机系统的不同分支，嵌入式系统和人们熟悉的通用计算机系统既有共性也有差异。

1．嵌入式系统和通用计算机系统的共同点

嵌入式系统和通用计算机系统都属于计算机系统，从系统组成上讲，它们都是由硬件和软件构成的；工作原理是相同的，都是存储程序机制。从硬件上看，嵌入式系统和通用计算机系统都是由CPU、存储器、I/O接口和中断系统等部件组成；从软件上看，嵌入式系统软件和通用计算机软件都可以划分为系统软件和应用软件两类。

2．嵌入式系统和通用计算机系统的不同点

1）形态。通用计算机系统具有基本相同的外形（如主机、显示器、鼠标和键盘等）并且独立存在；而嵌入式系统通常隐藏在具体某个产品或设备（称为宿主对象，如空调、洗衣机、数字机顶盒等）中，它的形态随着产品或设备的不同而不同。

2）功能。通用计算机系统一般具有通用而复杂的功能，任意一台通用计算机都具有文档编辑、影音播放、娱乐游戏、网上购物和通信聊天等通用功能；而嵌入式系统嵌入在某个宿主对象中。功能由宿主对象决定，具有专用性，通常是为某个应用量身定做的。

3）功耗。目前，通用计算机系统的功耗一般为200W左右；而嵌入式系统的宿主对象通常是小型应用系统，如手机、MP3和智能手环等，这些设备不可能配置容量较大的电源，因此，低功耗一直是嵌入式系统追求的目标，如日常生活中使用的智能手机，其待机功率100～200mW，即使在通话时功率也只有4～5W。

4）资源。通用计算机系统通常拥有大而全的资源（如鼠标、键盘、硬盘、内存条和显示器等）；而嵌入式系统受限于嵌入的宿主对象（如手机、MP3和智能手环等），通常要求小型化和低功耗，其软硬件资源受到严格的限制。

5）价值。通用计算机系统的价值体现在“计算”和“存储”上，计算能力（处理器的字长和主频等）和存储能力（内存和硬盘的大小和读取速度等）是通用计算机的通用评价指标；而嵌入式系统往往嵌入到某个设备和产品中，其价值一般不取决于其内嵌的处理器的性能，而体现在它所嵌入和控制的设备。如一台智能洗衣机往往用洗净比、洗涤容量和脱水转速等来衡量，而不以其内嵌的微控制器的运算速度和存储容量等来衡量。

# 1.1.3 嵌入式系统的特点

通过嵌入式系统的定义和嵌入式系统与通用计算机系统的比较，可以看出嵌入式系统具有以下特点。

1．专用性强

嵌入式系统通常是针对某种特定的应用场景，与具体应用密切相关，其硬件和软件都是面向特定产品或任务而设计的。不但一种产品中的嵌入式系统不能应用到另一种产品中，甚至都不能嵌入同一种产品的不同系列。例如，洗衣机的控制系统不能应用到洗碗机中，甚至不同型号洗衣机中的控制系统也不能相互替换，因此嵌入式系统具有很强的专用性。

2\.  可裁剪性

受限于体积、功耗和成本等因素，嵌入式系统的硬件和软件必须高效率地设计，根据实际应用需求量体裁衣，去除冗余，从而使系统在满足应用要求的前提下达到最精简的配置。

3\.  实时性好

许多嵌入式系统应用于宿主系统的数据采集、传输与控制过程时，普遍要求嵌入式系统具有较好的实时性。例如，像现代汽车中的制动器、安全气囊控制系统、武器装备中的控制系统、某些工业装置中的控制系统等。这些应用对实时性有着极高的要求，一旦达不到应有的实时性，就有可能造成极其严重的后果。

4\.	  可靠性高

嵌入式系统的应用场景多种多样，面对复杂的应用环境，嵌入式系统应能够长时间稳定可靠地运行。在某些应用中，嵌入式系统硬件或软件中存在的一个小“bug”，都有可能 导致灾难性后果的发生。

5\.	  体积小、功耗低

由于嵌入式系统要嵌入具体的应用对象体中，其体积大小受限于宿主对象，因此往往对体积有着严格的要求，例如，心脏起搏器的大小就像一粒胶囊。同时，由于嵌入式系统在移动设备、可穿戴设备以及无人机、人造卫星等这样的应用设备中，不可能配置交流电源或大容量的电池，因此低功耗也往往是嵌入式系统所追求的一个重要指标。

6\.	  注重制造成本

与其他商品一样，制造成本会对嵌入式系统设备或产品在市场上的竞争力有很大的影响。同时嵌入式系统产品通常会进行大量生产，例如，现在的消费类嵌入式系统产品，通常的年产量会在百万数量级、千万数量级甚至亿数量级。节约单个产品的制造成本，意味着总制造成本的海量节约，会产生可观的经济效益。因此注重嵌入式系统的硬件和软件的高效设计，量体裁衣、去除冗余，在满足应用需求的前提下有效地降低单个产品的制造成本，也成为嵌入式系统所追求的重要目标之一。

7\.	  生命周期长

随着计算机技术的飞速发展，像桌面计算机、笔记本电脑以及智能手机这样的通用计算机系统的更新换代速度大大加快，更新周期通常为18个月左右。然而嵌入式系统和实际具体应用装置或系统紧密结合，一般会伴随具体嵌入的产品维持8～10年相对较长的使用时间，其升级换代往往是和宿主对象系统同步进行的。因此，相较于通用计算机系统而言，嵌入式系统产品一旦进入市场后，不会像通用计算机系统那样频繁换代，通常具有较长的 生命周期。

8\.   不可垄断性

代表传统计算机行业的Wintel（Windows\-Intel）联盟统治桌面计算机市场长达30多年，形成了事实上的市场垄断。而嵌入式系统是将先进的计算机技术、半导体电子技术和网络通信技术与各个行业的具体应用相结合后的产物，其拥有更为广阔和多样化的应用市场，行业细分市场极其宽泛，这一点就决定了嵌入式系统必然是一个技术密集、资金密集、高度分散、不断创新的知识集成系统。特别是5G技术、物联网技术以及人工智能技术与嵌入式系统的快速融合，催生了嵌入式系统创新产品的不断涌现，没有一家企业能够形成对嵌入式系统市场的垄断，给嵌入式系统产品的设计研发提供了广阔的市场空间。

# 1.2 嵌入式系统的组成

嵌入式系统是一个在功能、可靠性、成本、体积和功耗等方面有严格要求的专用计算机系统，那么无一例外，具有一般计算机组成结构的共性。从总体上看，嵌入式系统的核心部分由嵌入式硬件和嵌入式软件组成，而从层次结构上看，嵌入式系统可划分为硬件层、驱动层、操作系统层以及应用层四个层次，如图1\-1所示。

嵌入式硬件（硬件层）是嵌入式系统的物理基础，主要包括嵌入式处理器、存储器、输入／输出（I/O）接口及电源等。其中，嵌入式处理器是嵌入式系统的硬件核心，通常可分为嵌入式微处理器、嵌入式微控制器、嵌入式数字信号处理器以及嵌入式片上系统等主要类型。

存储器是嵌入式系统硬件的基本组成部分，包括RAM、Flash、EEPROM等主要类型，承担着存储嵌入式系统程序和数据的任务。目前的嵌入式处理器中已经集成了较为丰富的存储器资源，同时也可通过I/O接口在嵌入式处理器外部扩展存储器。

I/O接口及设备是嵌入式系统对外联系的纽带，负责与外部世界进行信息交换。

I/O接口主要包括数字接口和模拟接口两大类，其中，数字接口又可分为并行接口和串行接口，模拟接口包括模数转换器（ADC）和数模转换器（DAC）。并行接口可以实现数据的所有位同时并行传送，传输速度快，但通信线路复杂，传输距离短。串行接口则采用数据位一位位顺序传送的方式，通信线路少，传输距离远，但传输速度相对较慢。常用的串行接口有通用同步／异步收发器（USART）接口、串行外设接口（SPI）、芯片间总线（P2C）接口以及控制器局域网络（CAN）接口等，实际应用时可根据需要选择不同的接口类型。I/O设备主要包括人机交互设备（按键、显示器件等）和机机交互设备（传感器、执行器等），可根据实际应用需求来选择所需的设备类型。

# 1.3 实时操作系统

作为管理计算机硬件与软件资源的程序，操作系统（Operating System，OS）在现代计算机体系结构中占有重要的地位。目前，广泛使用的操作系统有3类，即批处理操作系统、分时操作系统及实时操作系统。

批处理操作系统不具有用户交互性，用户将作业提交给操作系统执行后就不再干预，多用于早期的大中型计算机系统，例如IBM公司的DOS/VSE系统。

分时操作系统可以让多个计算机用户共享系统资源，及时响应和服务于联机用户，多应用于网络操作系统，例如UNIX系统。但是对于分时操作系统来说，软件的执行在时间上的要求并不严格。

<span style="color:#000000">实时操作系统是对事件进行实时的处理，虽然事件可能在无法预知的时刻到达，但是软件在事件发生时必须能够在严格的时限内作出响应（系统响应时间），即使是在尖峰负荷下，也应如此。若不满足时限，则可能造成灾难性的后果，尤其在航天、军事、工业控制等系统响应时间要求较为严格的领域中。</span>

<span style="color:#000000">同时，实时操作系统的重要特点是具有系统的可确定性，即系统能对运行情况的最好和最坏运行时间做出精确估计。因此，实时操作系统在现代工业、军事、能源、自动化、通信等方面有着重要的应用。</span>

# 1.3.1 实时系统的概念

在实时系统中，程序执行的正确性，既包括逻辑结果的正确性，也包括运行时间的约束性。如果一个系统能够及时地响应外部或者内部的事件请求，在指定或者确定时间内完成对该事件的处理，那么称该系统具有“实时性”。而一个操作系统若能够在有限确定的时间内对异步输入进行处理并输出结果，同时具有事件驱动性，则这个操作系统具备了“实时性”，可以称为“实时操作系统”（Real Time Operating System，RTOS）。

实时操作系统是一种既能提供有效机制和服务来保证系统的实时性调度和资源管理，也能保证时间和资源的可预测性以及可计算性的操作系统。

<span style="color:#000000"> __1\.3\.2 实时操作系统的基本特征__ </span>

实时操作系统具有实时性、可靠性、可确定性和容错性。

1．实时性

实时操作系统保证系统能够在预定或规定的时间内完成对外部事件的响应和处理。每个实时任务具有时间约束，所有实时任务必须要保证在任何情况下，都能按照实时任务调度算法满足其时间约束。实时性是实时操作系统最基本的特征。为了保证系统的实时性，系统通常既需要依赖于硬件提供精确的时钟精度，也需要系统本身具有高精度计时系统，以确定实时应用中某个任务或者函数执行的时间。

2\.	  可靠性

实时系统执行中产生的故障可能会导致人身、财产等重大损失。实时操作系统需要保证系统能够正确、实时地执行，并且将产生故障的概率降到可以控制范围之内。同时，通过特定的机制使得系统在故障产生时仍然能够有效地执行部分关键性任务，最大限度地降低由于不可抗拒故障因素给系统带来的不良影响。

3\.	  可确定性

实时操作系统的任务可确定性是指实时操作系统的任务必须按照预定时间或者时间间隔进行任务的调度和执行。当多个任务竞争使用处理器和资源时，实时操作系统可以采取中断机制或者调度算法来保证任务的正确执行。系统实时性的保证依赖于系统能够准确地对任务的执行时间进行判断，包括硬件延迟的确定性和应用程序响应时间的确定性，保证应用程序执行时间是有界的，从而保证实时任务的执行能够满足时间约束。

4\.	  容错性

对于系统在执行过程中产生的错误或者故障，实时操作系统能够通过有效的算法等机制来预估其带来的影响，并且最小化其带来的影响，保证系统在最坏的情况下对于部分关键性任务仍然能正确执行。容错性是相对于可靠性而言的，可靠性着重于在系统错误发生之前，通过优化调度算法等机制来尽力消除所有潜在的故障。而容错性则强调即使发生了故障，也要保障系统能够正常工作。尽管系统在设计时通过了严格的测试和验证，但是在运行中产生的软件和硬件错误还是不可避免的，所以实时操作系统的容错性更加至关重要。

# 1.3.3  实时操作系统性能的衡量指标

对于一个实时操作系统性能评估的测量基准有 Wetstone、Dhrystone、Hartstone 以及 Rhealstone 等。Rhealstone 基准是目前作为工业界评判实时系统性能指标的主要基准之一。通过对实时操作系统的6个时间量进行计算，将其加权获得Rhealstone数，数值越小，证明该系统实时性越好。这6个时间量为：

（1）任务切换时间（上下文切换时间，context switch time）：系统在两个独立的任务之间切换所需要的时间。

（2）抢占时间（preemption time）：系统从正在执行的低优先级任务转移到开始执行高优先级任务所需要的时间。

（3）中断延迟时间（interrupt latency time）：从接收到中断信号到操作系统做出响应，并完成进入中断服务例程所需要的时间。

（4）信号量混洗时间（semaphore shuffling time）：由于系统多任务执行的互斥原理，在一个任务执行完成后释放信号量到另一个等待该信号量的任务被激活所需要的时间间隔。

（5）死锁解除时间（deadlock breaking time）：系统进入死锁状态到解除死锁顺利执行所需要的时间。

（6）数据包吞吐时间\(datagram throuShput time\)：一个任务进行数据传输到另一个任务，每秒可以传输的字节数。

任务若没有在截止时间完成，实时操作系统根据所造成后果的严重程度分为硬实时和软实时操作系统。

1．硬实时操作系统

硬实时操作系统具有刚性的时限，要求所有的任务必须在任何条件下（即使在最坏的各种处理负载下）都能在规定的时间内完成，任何任务超过其截止时间都会造成系统整体的失败。任务超过截止时间会导致灾难性的后果，系统的收益为负无穷。例如，导弹控制系统、自动驾驶系统等的操作系统都属于硬实时操作系统。

2\.	  软实时操作系统

相对于硬实时操作系统，软实时操作系统具有一定的“容忍度”。软实时具有灵活的时限，任务超过其截止时间所造成的后果没有那么严重，可能仅仅降低了系统的吞吐量而已。任务超过截止时间不会导致严重的后果，系统的收益也可能为正。例如，IPTV 数字电视机顶盒，需要实时解码视频流，如果丢失了一个或几个视频帧，显然会造成视频的品质变差，但是只要做简单的抖动处理，丢失几个视频帧不会对整个系统造成不可挽回的影响。

# 1.3.5 POSIX 标准

可移植性操作系统接口（Portable Operating System Interface of UNIX，POSIX）是由电气和电子工程师协会（Institute of Electrical and Electronics Engineers，IEEE）开发的操作系统接口标准。

作为一个标准的软件接口，POSIX的主要目的是在跨越UNIX各种变型操作系统之间，完善应用程序的互操作性和可移植性。理论上，只要两个操作系统都支持POSIX，如果写的程序和编译的程序能够在一个操作系统上执行，那么该程序也可以在不改变源代码的情况下通过编译在另一个操作系统上执行。

POSIX标准定义了操作系统为应用程序提供的标准接口，以及与操作系统各个方面相关的内容和协议。目前该标准已经成为实时操作系统的主要标准之一。虽然 POSIX 早期为在UNIX环境下应用程序的可移植性而开发，但后来发展起来后，也适用于包括UNIX在内的其他操作系统。

POSIX标准设计的目的是为了保证一个支持POSIX兼容操作系统的程序可以应用在任何一个（即使来自于其他厂商开发）POSIX操作系统上，无须修改便可以编译执行。

<span style="color:#000000"> __1\.3\.6 实时操作系统的典型应用__ </span>

实时操作系统主要应用在需要实时处理大数据量或者大运算量的并行系统中。

航空航天领域采用硬实时系统来确保时间。例如，美国“好奇号”火星探测车就是采用VxWroks 硬实时操作系统。

对于工业制造领域，涉及人身安全或者执行重要任务时通常采用硬实时系统，例如，飞机控制系统以及汽车安全气囊系统等。

军事领域中也通常采用性能稳定的实时系统，例如，美国的FA\-18、F\-16战斗机以及爱国者导弹等。

通信或者电子产品领域，例如，IPTV 电视机顶盒通常采用软实时操作系统对视频进行实时解码。

# 1.4  嵌入式系统的软件

嵌入式系统的软件一般固化于嵌入式存储器中，是嵌入式系统的控制核心，控制着嵌入式系统的运行，实现嵌入式系统的功能。由此可见，嵌入式软件在很大程度上决定整个嵌入式系统的价值。

从软件结构上划分，嵌入式系统的软件分为无操作系统和带操作系统两种。

# 1.4.1  无操作系统的嵌入式软件

对于通用计算机，操作系统是整个软件的核心，不可或缺；然而，对于嵌入式系统，由于其专用性，在某些情况下无需操作系统。尤其在嵌入式系统发展的初期，由于较低的硬件配置、单一的功能需求以及有限的应用领域（主要集中在工业控制和国防军事领域），嵌入式软件的规模通常较小，没有专门的操作系统。

在组成结构上，无操作系统的嵌入式软件仅由引导程序和应用程序两部分组成，如图1\-2所示。引导程序一般由汇编语言编写，在嵌入式系统上电后运行，完成自检、存储映射、时钟系统和外设接口配置等一系列硬件初始化操作。应用程序一般由C语言编写，直接架构在硬件之上，在引导程序之后运行，负责实现嵌入式系统的主要功能。

![](img%5C%E7%AC%AC1%E7%AB%A0%20%E7%BB%AA%E8%AE%BA20250331195139192.wmf)

# 图1-2 无操作系统嵌入式软件结构

<span style="color:#000000"> __1\.4\.2 带操作系统的嵌入式软件__ </span>

随着嵌入式应用在各个领域的普及和深入，嵌入式系统向多样化、智能化和网络化发展，其对功能、实时性、可靠性和可移植性等方面的要求越来越高，嵌入式软件日趋复杂，越来越多地采用嵌入式操作系统十应用软件的模式。相比无操作系统的嵌入式软件，带操作系统的嵌入式软件规模较大，其应用软件架构于嵌入式操作系统上，而非直接面对嵌入式硬件，可靠性高，开发周期短，易于移植和扩展，适用于功能复杂的嵌入式系统。

带操作系统的嵌入式软件的体系结构如图1\-3所示，自下而上包括设备驱动层、操作系统层和应用软件层等。

![](img%5C%E7%AC%AC1%E7%AB%A0%20%E7%BB%AA%E8%AE%BA20250331195139193.wmf)

# 图1-3 带操作系统的嵌入式软件的体系结构构

# 1.4.3  嵌入式操作系统的分类

按照嵌入式操作系统对任务响应的实时性来分类，嵌入式操作系统可以分为嵌入式非实时操作系统和嵌入式实时操作系统（RTOS）。这两类操作系统的主要区别在于任务调度处理方式不同。

1．嵌入式非实时操作系统

嵌入式非实时操作系统主要面向消费类产品应用领域。大部分嵌入式非实时操作系统都支持多用户和多进程，负责管理众多的进程并为它们分配系统资源，属于不可抢占式操作系统。

典型的非实时操作系统有Linux、iOS等。

2\.  嵌入式实时操作系统

嵌入式实时操作系统主要面向控制、通信等领域。实时操作系统除了要满足应用的功能需求，还要满足应用提出的实时性要求，属于抢占式操作系统。

嵌入式实时操作系统能及时响应外部事件的请求，并以足够快的速度予以处理，其处理结果能在规定的时间内控制、监控生产过程或对处理系统做出快速响应，并控制所有任务协调、一致地运行。

典型的嵌入式实时操作系统有VxWork、μCOS\-II、QNX、FreeRTOS、eCOS、RTX及 RT\-Thread等。

# 1.4.4  嵌入式实时操作系统的功能

嵌入式实时操作系统满足了实时控制和实时信息处理领域的需要，在嵌入式领域应用十分广泛，一般有实时内核、内存管理、文件系统、图形接口、网络组件等。在不同的应用中，可对嵌入式实时操作系统进行剪裁和重新配置。一般来讲，嵌入式实时操作系统需要完成以下管理功能。

1．任务管理

任务管理是嵌入式实时操作系统的核心和灵魂，决定了操作系统的实时性能。任务管理通常包含优先级设置、多任务调度机制和时间确定性等部分。

嵌入式实时操作系统支持多个任务，每个任务都具有优先级，任务越重要，被赋予的优先级越高。

2\.	  任务同步与通信机制

实时操作系统的功能一般要通过若干任务和中断服务程序共同完成。任务与任务之间、任务与中断间任务及中断服务程序之间必须协调动作、互相配合，这就涉及任务间的同步与通信问题。嵌入式实时操作系统通常是通过信号量、互斥信号量、事件标志和异步信号来实现同步的，是通过消息邮箱、消息队列、管道和共享内存来提供通信服务的。

3\.	  内存管理

通常在操作系统的内存中既有系统程序也有用户程序，为了使两者都能正常运行，避免程序间相互干扰，需要对内存中的程序和数据进行保护。存储保护通常需要硬件支持，很多系统都采用MMU，并结合软件实现这一功能；但由于嵌入式系统的成本限制，内核和用户程序通常都在相同的内存空间中。内存分配方式可分为静态分配和动态分配。静态分配是在程序运行前一次性分配给相应内存，并且在程序运行期间不允许再申请或在内存中移动；动态分配则允许在程序运行的整个过程中进行内存分配。静态分配使系统失去了灵活性，但对实时性要求比较高的系统是必需的；而动态分配赋予了系统设计者更多自主性，系统设计者可以灵活地调整系统的功能。

4\.	  中断管理

中断管理是实时系统中一个很重要的部分，系统经常通过中断与外部事件交互。评估系统的中断管理性能主要考虑的是是否支持中断嵌套、中断处理机制、中断延时等。中断处理是整个运行系统中优先级最高的代码，它可以抢占任何任务级代码运行。中断机制是多任务环境运行的基础，是系统实时性的保证。

# 1.4.5 典型嵌入式操作系统

随着嵌入式技术的快速发展，国内外先后问世了150多种嵌入式操作系统，较为常见的国外嵌入式操作系统有μC/OS、FreeRTOS、Embedded Linux、VxWorks、QNX、RTX、Windows IoT Core、Android Things等。虽然国产嵌入式操作系统发展相对滞后，但在物联网技术与应用的强劲推动下，国内厂商也纷纷推出了多种嵌入式操作系统，并得到了日益广泛的应用。目前较为常见的国产嵌入式操作系统有华为Lite OS、华为HarmonyOS、阿里 AliOS Things、翼辉SylixOS、赛睿德RT\-Thread等。

1\.	  华为Lite OS

Lite OS是华为技术有限公司（简称华为）于2015年5月发布的轻量级开源物联网嵌入式操作系统，遵循BSD\-3开源许可协议，最新版本是1\.1\.0。其内核包括任务管理、内存管理、时间管理、通信机制、中断管理、队列管理、事件管理、定时器、异常管理等操作系统的基础组件。组件均可以单独运行。另外还提供了软件开发工具包 Lite OS SDK。目前Lite OS 支持 Arm Cortex\-M0/M3/M4/M7等芯片架构，适配了包括 ST、NXP、GD、MindMotion、Silicon、Atmel等主流开发商的开发板，具备“零配置”、“自发现”和“自组网”的能力。

Lite OS的特点主要包括：

1）高实时性、高稳定性。

2）超小内核，基础内核体积可以裁剪至不到10KB。

3）低功耗，最低功耗可在μW级。

4）支持动态加载和分散加载。

5）支持功能静态裁剪。

6）开发门槛低，设备布置以及维护成本低，开发周期短，可广泛应用于智能家居、个人穿戴、车联网、城市公共服务、制造业等领域。

2\.	  华为Harmony OS（Hongmeng OS，鸿蒙OS）

Harmony OS是华为推出的基于微内核的全场景分布式嵌入式操作系统，2017年推出鸿蒙内核1\.0版本，2020年9月迭代到2\.0版本。Harmony OS采用了微内核设计，通过简化内核功能，使内核只提供多进程调度和多进程通信等最基础的服务，而让内核之外的用户态尽可能多地实现系统服务，同时添加了相互之间的安全保护，拥有更强的安全特性和更低的时延。

3\.	  阿里 AliOS Things

AliOS Things 是阿里巴巴集团控股有限公司（简称阿里巴巴）面向物联网领域推出的轻量级开源物联网嵌入式操作系统，2017年11月发布1\.1\.0版本，2020年4月迭代到3\.1\.0版本。除操作系统内核外，AliOS Things包含了硬件抽象层、板级支持包、协议栈、中间件、AOS API 以及应用示例等组件，支持各种主流的CPU架构，包括 Arm Cortex\-M0＋／M3/M4/M7/A7/A53/A72、RISC\-V、C\-SKY、MIPS\-I和Renesas等。

4\.	  翼辉 SylixOS

SylixOS是由北京翼辉信息技术有限公司推出的开源嵌入式实时操作系统。从2006年开始研发，经过多年的持续开发与改进，已成为一个功能全面、稳定可靠、易于开发的大型嵌入式实时操作系统平台。翼辉SylixOS采用小而巧的硬实时内核，支持256个优先级抢占式调度和优先级继承，支持虚拟进程和无限多任务数，调度算法先进、高效、性能强劲。

5\.	  睿赛德RT\-Thread

RT\-Thread的全称是Real Time\-Thread，是由上海睿赛德电子科技有限公司推出的一个开源嵌入式实时多线程操作系统，目前最新版本是4\.0。3\.1\.0及以前的版本遵循GPL V2＋开源许可协议，从3\.1\.0以后的版本遵循Apache License 2\.0开源许可协议。RT\-Thread 主要由内核层、组件与服务层、软件包三个部分组成。其中，内核层包括 RT\-Thread 内核和libcpu/BSP（芯片移植相关文件／板级支持包）。RT\-Thread内核是整个操作系统的核心部分，包括多线程及其调度、信号量、邮箱、消息队列、内存管理、定时器等内核系统对象的实现，而Libcpu/BSP与硬件密切相关，由外设驱动和CPU移植构成。

6．μC/OS\-II

μC/OS\-II（Micro\-Controller Operating System Two）是一种基于优先级的可抢占式的硬实时内核。它属于一个完整、可移植、可固化、可裁减的抢占式多任务内核，包含了任务调度、任务管理、时间管理、内存管理和任务间的通信和同步等基本功能。μC/OS\-II嵌入式系统可用于各类8位单片机、16位和32位微控制器和数字信号处理器。

嵌入式系统μC/OS\-II源于Jean J\.Labrosse在1992年编写的一个嵌入式多任务实时操作系统（RTOS），1999年改写后命名为μC/OS\-II，并在2000年被美国航空管理局认证。μC/OS\-II系统具有足够的安全性和稳定性，可以运行在诸如航天器等对安全要求极为苛刻的系统之上。

μC/OS\-II系统的主要特点如下：

（1）开源性。

μC/OS\-II系统的源代码全部公开，用户可直接登录μC/OS\-II的官方网站下载，网站上公布了针对不同微处理器的移植代码。用户也可以从有关出版物上找到详尽的源代码讲解和注释。这样使系统变得透明，极大地方便了μC/OS\-II系统的开发，提高了开发效率。

（2）可移植性。

绝大部分μC/OS\-II系统的源码是用移植性很强的ANSIC语句写的，和微处理器硬件相关的部分是用汇编语言写的。汇编语言编写的部分已经压缩到最小限度，使得μC/OS\-II系统便于移植到其他微处理器上。

μC/OS\-II系统能够移植到多种微处理器上的条件是，只要该微处理器有堆栈指针，有CPU内部寄存器入栈、出栈指令。

（3）可固化。

μC/OS\-II系统是为嵌入式应用而设计的，只要具备合适的软、硬件工具，μC/OS\-II系统就可以嵌入到用户的产品中，成为产品的一部分。

（4）可裁剪。

用户可以根据自身需求只使用μC/OS\-II系统中应用程序中需要的系统服务。这种可裁剪性是靠条件编译实现的。只要在用户的应用程序中（用＃define constants 语句）定义那些μC/OS\-II系统中的功能是应用程序需要的就可以了。

（5）抢占式。

μC/OS\-II系统是完全抢占式的实时内核。μC/OS\-II系统总是运行就绪条件下优先级最高的任务。

（6）多任务。

μC/OS\-II系统2\.8\.6版本可以管理256个任务，目前预留8个给系统，因此应用程序最多可以有248个任务。系统赋予每个任务的优先级是不相同的，μC/OS\-II系统不支持时间片轮转调度法。

（7）可确定性。

μC/OS\-II系统全部的函数调用与服务的执行时间都具有可确定性。也就是说，μC/OS\-II系统的所有函数调用与服务的执行时间是可知的。进而言之，μC/OS\-II系统服务的执行时间不依赖于应用程序任务的多少。

（8）任务栈。

μC/OS\-II系统的每一个任务有自己单独的栈，μC/OS\-II系统允许每个任务有不同的栈空间，以便压低应用程序对RAM的需求。使用μC/OS\-II系统的栈空间校验函数，可以确定每个任务到底需要多少栈空间。

（9）系统服务。

μC/OS\-II系统提供很多系统服务，例如邮箱、消息队列、信号量、块大小固定的内存的申请与释放、时间相关函数等。

（10）中断管理，支持嵌套。

中断可以使正在执行的任务暂时挂起。如果优先级更高的任务被该中断唤醒，则高优先级的任务在中断嵌套全部退出后立即执行，中断嵌套层数可达255层。

一些典型的应用领域如下。

（1）汽车电子方面：发动机控制、防抱死系统（ABS）、全球定位系统（GPS）等；

（2）办公用品：传真机、打印机、复印机、扫描仪等；

（3）通信电子：交换机、路由器、调制解调器、智能手机等；

（4）过程控制：食品加工、机械制造等；

（5）航空航天：飞机控制系统、喷气式发动机控制等；

（6）消费电子：MP3/MP4/MP5播放器、机顶盒、洗衣机、电冰箱、电视机等；

（7）机器人和武器制导系统等。

7\.  嵌入式Linux

Linux 诞生于1991年10月5日，是一套开源、免费使用和自由传播的类UNIX的操作系统。Linux是一个基于POSIX和UNIX的支持多用户、多任务、多线程和多CPU的操作系统。它能运行主要的UNIX 工具软件、应用程序和网络协议，支持32位和64位硬件。Linux 继承了UNIX以网络为核心的设计思想，Linux是一个性能稳定的多用户网络操作系统，存在许多不同的版本，但它们都使用了Linux内核。Linux可安装在计算机硬件中，如手机、平板电脑、路由器、视频游戏控制台、台式计算机、大型机和超级计算机。

Linux 遵守 GPL 协议，无须为每例应用交纳许可证费，并且拥有大量免费且优秀的开发工具和庞大的开发人员群体。

嵌入式Linux具有以下特点：

（1）嵌入式Linux是完全开源的，因此它广泛应用于高校教学。Internet上的资源丰富，还有大量的图书资料，学习Linux系统的代价最小。

（2）嵌入式Linux是免费的，不涉及任何版权和专利。这一点被商界所看重，因此，大部分嵌入式产品在初期都使用过嵌入式Linux版本。嵌入式Linux 被很多团体和组织二次开发后，形成具有独立知识产权的嵌入式操作系统，所以，嵌入式Linux变种系统非常多，如WindRiver Linux和μCLinux等。

（3）嵌入式Linux与QT相结合，使嵌入式Linux具有良好的图形人机界面，甚至可以和Windows CE相媲美，而且QT目前也是开源的。

（4）嵌入式Linux的移植能力强，其变种形式几乎可应用于所有主流嵌入式系统中。嵌入式Linux对外设的驱动能力很强，驱动接口程序设计相对容易，网络上有大量常用设备的驱动代码可供参考借鉴。

（5）嵌入式Linux在内核、文件系统、网络支持等方面均有突出的特点。新的Linux内核，具有200多万行源代码，可支持32个CPU，实时性显著提高（但严格意义上不是实时操作系统），采用了更有效的任务调度器，增加了对多种嵌入式处理器的支持，在多媒体和网络通信方面也有很大提高。

8\.	  VxWorks

VxWorks是美国 WindRiver公司于1983年设计研发的一种嵌入式实时操作系统，有良好的持续发展能力、可裁剪微内核结构、高效的任务管理、灵活的任务间通信、微秒级的中断处理友好的开发环境等优点。由于其良好的可靠性和卓越的实时性，VxWorks被广泛地应用在通信军事、航空、航天等高精尖技术及实时性要求极高的领域，如卫星通信、军事演习、弹道制导飞机导航等。VxWorks不提供源代码，只提供二进制代码和应用接口。

VxWorks具有以下特点：

可靠性极高、实时性好、可裁剪性好、开发环境友好。

9\.	  Android

目前，Google的Android系统已经是家喻户晓的嵌入式操作系统，也是苹果（Apple）公司的操作系统iOS的主要竞争对手。

Android系统基于Linux系统，是Google在2005年并购 Danger 公司后发展他们Android计划的成果（当时由于iPhone取得了巨大成功，该计划实质上制定了与iOS竞争的策略）。Andy Rubin是这个计划的负责人，主要针对智能手持设备。Android的运行库文件只有250KB，最基本内存配置为32MB内存、32MB闪存和200MHz处理器。

开发Android系统应用程序与开发 Windows CE应用程序类似，可基于SDK包和Eclipse集成开发环境，或基于 Android Studio集成开发环境实现，就目前来说，相对于Windows CE和iOS，Android系统还没有明显的劣势。

Android是一种基于Linux的自由及开放源代码的操作系统，主要应用于移动设备，如智能手机和平板电脑。

Android逐渐扩展到平板电脑及其他领域上，如电视、数码相机、游戏机、智能手表等。

10\. Windows CE

Windows Embedded Compact（即 Windows CE）是微软公司嵌入式、移动计算平台的基础，它是一个可抢先式、多任务、多线程并具有强大通信能力的32位嵌入式操作系统，是微软公司为移动应用、信息设备、消费电子和各种嵌人式应用而设计的实时系统。

Windows CE是模块化的操作系统，主要包括4个模块，即内核（Kernel）、文件子系统、图形窗口事件子系统（GWES）和通信模块。

嵌入式操作系统μC/OS\-II移植与应用随着嵌入式系统的开发成为行业热点。在嵌入式应用中移植μC/OS\-II系统，大大减轻了应用程序设计员的负担，不必每次从头开始设计软件，代码可重用率高。

相对于其他嵌入式实时操作系统而言，Windows CE具有以下优点。

（1）具有美观的图形用户界面，而且该界面与桌面Windows系统一脉相承，使得操作直观简单。

（2）开发基于Windows CE的应用程序相对简单，因为Windows CE的API函数集是桌面Windows系统API函数的子集，熟悉桌面Windows程序设计的程序员可以很快地掌握 Windows CE应用程序的设计方法，所以，Windows CE应用程序的开发成本较低。

（3）Windows CE的文件管理功能非常强大，支持桌面Windows 系统下的FAT、FAT32等。

（4）Windows CE的可移植性较好。

（5）Windows CE下的设备驱动程序开发相对容易。

（6）Windows CE的电源管理功能较好，主要体现在Windows Phone上。

（7）Windows CE的进程管理和中断处理机制较好。

（8）Windows CE支持桌面 Windows系统的众多文件格式，例如Word和Excel等，这种兼容性方便桌面Windows用户在Windows CE设备上处理文档和数据。

Windows CE凭借上述的突出优点，在便携设备、信息家电和工业监控等领域得到了广泛的应用。

# 1.4.6  软件架构选择建议

从理论上讲，基于操作系统的开发模式具有快捷、高效的特点，开发的软件移植性、后期维护性、程序稳健性等都比较好。但不是所有系统都要基于操作系统，因为这种模式要求开发者对操作系统的原理有比较深入的掌握，一般功能比较简单的系统，不建议使用操作系统，毕竟操作系统也占用系统资源；也不是所有系统都能使用操作系统，因为操作系统对系统的硬件有一定的要求。

因此，在通常情况下，虽然STM32单片机是32位系统，但不主张嵌入操作系统。如果系统足够复杂，任务足够多，又或者有类似于网络通信、文件处理、图形接口需求加入时，不得不引入操作系统来管理软硬件资源时，也要选择轻量化的操作系统，比如选择μC/OS\-II的比较多，其相应的参考资源也比较多；建议不要选择 Linux、Android和Windows CE这样的重量级的操作系统，因为STM32F1系列微控制器硬件系统在未进行扩展时，是不能满足此类操作系统的运行需求的。

# 1.5 嵌人式系统的分类

嵌入式系统应用非常广泛，其分类也可以有多种多样的方式。可以按嵌入式系统的应用对象进行分类，也可以按嵌入式系统的功能和性能进行分类，还可以按嵌入式系统的结构复杂度进行分类。

按应用对象来分类，嵌入式系统主要分为军用嵌入式系统和民用嵌入式系统两大类。

军用嵌入式系统又可分为车载、舰载、机载、弹载、星载等，通常以机箱、插件甚至芯片形式嵌入相应设备和武器系统之中。军用嵌入式系统除了在体积小、重量轻、性能好等方面的要求之外，往往也对苛刻工作环境的适应性和可靠性提出了严格的要求。

民用嵌入式系统又可按其应用的商业、工业和汽车等领域来进行分类，主要考虑的是温度适应能力、抗干扰能力以及价格等因素。

# 1.5.2 按功能和性能的分类

按功能和性能来分类，嵌入式系统主要分为独立嵌入式系统、实时嵌入式系统、网络嵌入式系统和移动嵌入式系统等类别。

独立嵌入式系统是指能够独立工作的嵌入式系统，它们从模拟或数字端口采集信号，经信号转换和计算处理后，通过所连接的驱动、显示或控制设备输出结果数据。常见的计算器、音视频播放机、数码相机、视频游戏机、微波炉等就是独立嵌入式系统的典型实例。

实时嵌入式系统是指在一定的时间约束（截止时间）条件下完成任务执行过程的嵌入式系统。

网络嵌入式系统是指连接着局域网、广域网或互联网的嵌入式系统。

移动嵌入式系统是指具有便携性和移动性的嵌入式系统，如手机、手表、智能手环、数码相机、便携式播放器以及智能可穿戴设备等。移动嵌入式系统是目前嵌入式系统中最受欢迎的分类。

# 1.5.3 按结构复杂度的分类

按结构复杂度来分类，嵌入式系统主要分为小型嵌入式系统、中型嵌入式系统和复杂嵌入式系统三大类。

小型嵌入式系统通常是指以8位或16位处理器为核心设计的嵌入式系统。其处理器的内存（RAM）、程序存储器（ROM）和处理速度等资源都相对有限，应用程序一般用汇编语言或者嵌入式C语言来编写，通过汇编器或／和编译器进行汇编或/和编译后生成可执行的机器码，并采用编程器将机器码烧写到处理器的程序存储器中。例如，电饭锅、洗衣机、微波炉、键盘等就是小型嵌入式系统的一些常见实例。

中型嵌入式系统通常是指以16位、32位处理器或数字信号处理器为核心设计的嵌入式系统。这类嵌入式系统相较于小型位、32位处理合政高的硬件和软件复杂性，嵌入式应用要用C、C＋H、Java、实时操作系统、调试器、模拟器和集成开发环境等工具进行开发，如POS机、不间断电源（UPS）、扫描仪、机顶盒等。

复杂嵌入式系统与小型和中型嵌入式系统相比具有极高的硬件和软件复杂性，执行更为复杂的功能，需要采用性能更高的32位或64位处理器、专用集成电路（ASIC）或现场可编程逻辑阵列（FPGA）器件来进行设计。这类嵌入式系统有着很高的性能要求，需要通过软、硬件协同设计的方式将图形用户界面、多种通信接口、网络协议、文件系统甚至数据库等软、硬件组件进行有效封装。例如，网络交换机、无线路由器、IP摄像头、嵌入式Web服务器等系统就属于复杂嵌入式系统。

# 1.6 嵌入式系统的应用领域

嵌入式系统主要应用在以下领域：

1）智能消费电子产品。

2）工业控制。

3）医疗设备。

4）信息家电及家庭智能管理系统。

5）网络与通信系统。

6）环境工程。

7）机器人。

# 1.7  嵌入式系统的体系

嵌入式系统是一个专用计算机应用系统，是一个软件和硬件集合体。图1\-4描述了一个典型嵌入式系统的组成结构。

嵌入式系统的硬件层一般由嵌入式处理器、内存、人机接口、复位／看门狗电路、I/O接电路等组成，它是整个系统运行的基础，通过人机接口和I/O接口实现和外部的通信。嵌入式统的软件层主要由应用程序、硬件抽象层、嵌入式操作系统和驱动程序、板级支持包组成中，嵌入式操作系统主要实现应用程序和硬件抽象层的管理，在一些应用场合可以不使用，接编写裸机应用程序）。嵌入式系统软件运行在嵌入式处理器中。在嵌入式操作系统的管理下设备驱动层将硬件电路接收控制指令和感知的外部信息传递给应用层，经过其处理后，将控制结果或数据再反馈给系统硬件层，完成存储、传输或执行等功能要求。

![](img%5C%E7%AC%AC1%E7%AB%A0%20%E7%BB%AA%E8%AE%BA20250331195139194.png)

__图__  __1\-4 __  __嵌入式系统层次结构模型__

# 1.7.1 硬件架构

嵌入式系统的硬件架构以嵌入式处理器为核心、由存储器、外围设备、通信模块、电源及复位等必要的辅助接口组成。嵌入式系统是量身定做的专用计算机应用系统、不同于普通计算机组成，在实际应用中的嵌入式系统硬件配置非常精简。除了微处理器和基本的外围设备，其余的电路都可根据需要和成本进行裁剪、定制，因此嵌入式系统硬件置非常经济、可靠。

随着计算机技术、微电子技术及纳米芯片加工工艺技术的发展。以微处理器为核心的集成多种功能的SoC（System on a Chip，片上系统）芯片已成为嵌入式系统的核心。这些SoC集成了大量的外围USB、以太网、ADC/DAC、IIS等功能模块。SOPC（System on a Programmable Chipe可编程片上系统）结合了SoC和PLD的技术优点，使得系统具有可编程的功能。是可编程逻辑器件在嵌入式应用中的完美体现，极大地提高了系统在线升级、换代的能力。以SoC/SOPC为核心，用最少的外围器件和连接器件构成一个应用系统。以满足系统的功能需求。是嵌入式系统发展的一个方向。

因此，嵌入式系统设计是以嵌入式微处理器／SoC/SOPC 为核心，结合外围接口设备，包括存储设备、通信扩展设备、扩展设备接口和辅助的设备（电源、传感、执行等），构成硬件系统以完成系统设计的。

# 1.7.2 软件层次

嵌入式系统软件结构一般包含3个层面：设备驱动层、OS层、应用层（包括硬件抽象层、应用程序）。由于嵌入式系统应用的多样性，需要根据不同的硬件电路和嵌入式系统应用特点，对软件部分进行裁剪。现代高性能嵌入式系统的应用越来越广泛，嵌入式操作系统的使用成为必然发展趋势。

1\.	 设备驱动层

设备驱动层一般由板级支持包和驱动程序组成，是嵌入式系统中不可或缺的部分，设备动层的作用是为上层程序提供外围设备的操作接口，并且实现设备的驱动程序。上层程序可以不管设备内部实现细节，只需调用设备驱动的操作接口即可。

1）板级支持包

板级支持包（Board Support Package，BSP）介于主板硬件和嵌入式操作系统中驱动程序之间的一层。BSP是所有与硬件相关的代码体的集合，为嵌入式操作系统的正常运行提供了最基本、最原始的硬件操作的软件模块，BSP和嵌入式操作系统息息相关，为上层的驱动程序提供了访问硬件的寄存器的函数包，使之能够更好地运行于主板硬件。

BSP可以分为以下三大功能。

（1）系统上电时的硬件初始化。例如，对系统内存、寄存器及设备的中断进行设置。这是比较系统化的工作，硬件上电初始化要根据嵌入式开发所选的CPU类型、硬件及嵌入式操作系统的初始化等多方面决定BSP应实现什么功能。

（2）为嵌入式操作系统访问硬件驱动程序提供支持。驱动程序经常需要访问硬件的寄存器，如果整个系统为统一编址，那么开发人员可直接在驱动程序中用C语言的函数访问硬件的寄存器。但是，如果系统为单独编址，那么C语言将不能直接访问硬件的寄存器，只有汇编语言编写的函数才能对硬件的寄存器进行访问。BSP 就是为上层的驱动程序提供访问硬件的寄存器的函数包。

（3）集成硬件相关和硬件无关的嵌入式操作系统所需的软件模块。BSP 是相对于嵌入式操作系统而言的，不同的嵌入式操作系统对应于不同定义形式的BSP。例如，VxWorks的BSP和Linux的BSP相对于某一CPU来说尽管实现的功能一样，但是写法和接口定义是完全不同的，所以写BSP一定要按照该系统BSP的定义形式（BSP的编程过程大多数是在某一个成型的BSP模板上进行修改的）。这样才能与上层嵌入式操作系统保持正确的接口，良好的支持上层嵌入式操作系统。

2）驱动程序

只有安装了驱动程序，嵌入式操作系统才能操作硬件平台，驱动程序控制嵌入式操作系统和硬件之间的交互。驱动程序提供一组嵌入式操作系统可理解的抽象接口函数。例如，设备初始化、打开、关闭、发送、接收等。一般而言，驱动程序和设备的控制芯片有关。驱动程序运行在高特权级的处理器环境中，可以直接对硬件进行操作，但正因为如此，任何一个设备驱动程序的错误都可能导致嵌入式操作系统的崩溃，因此好的驱动程序需要有完备的错误处理函数。

2\.  OS层

嵌入式操作系统是一种支持嵌入式系统应用的操作系统软件，是嵌入式系统的重要组成部分。嵌入式操作系统通常包括与硬件相关的底层驱动软件、系统内核、设备驱动接口、通信协议、图形界面、标准化浏览器等。嵌入式操作系统具有通用操作系统的基本特点。例如，能有效管理越来越复杂的系统资源；能把硬件虚拟化，使得开发人员从繁忙的驱动程序移植和维护中解脱出来；能提供库函数、驱动程序、工具集及应用程序。与通用操作系统相比较，嵌入式操作系统在系统实时高效性、硬件的相关依赖性、软件固态化及应用的专用性等方面具有较为突出的特点。嵌入式操作系统具有通用操作系统的基本特点，能够有效管理复杂的系统资源，并且把硬件虚拟化。

在一般情况下，嵌入式开发操作系统可以分为两类，一类是面向控制、通信等领域的嵌入式实时操作系统（RTOS），如 VxWorks、PSOS、QNX、μCOS\-II、RT\-Thread、FreeRTOS等；另一类是面向消费电子产品的嵌入式非实时操作系统，如Linux、Android、iOS等，这类产品包括智能手机、机顶盒、电子书等。

3\.   应用层

1）硬件抽象层

硬件抽象层本质上就是一组对硬件进行操作的API，是对硬件功能抽象的结果。硬件抽象层通过API为嵌入式操作系统和应用程序提供服务。但是，在Windows和Linux操作系统下，硬件抽象层的定义是不同的。

2）应用程序

应用程序是为完成某项或某几项特定任务而被开发运行于嵌入式操作系统之上的程序，如文件操作、图形操作等。在嵌入式操作系统上编写应用程序一般需要一些应用程序接口。

应用程序接口（Application Programming Interface，API）又称为应用编程接口，是软件系统不同组部分衔接的约定。应用程序接口的设计十分重要，良好的接口设计可以降低系统各部分的相互依赖性，提高组成单元的内聚性，降低组成单元间的耦合程度，从而提高系统的维护性和扩展性。

根据嵌入式系统应用需求，应用程序通过调用嵌入式操作系统的API函数操作系统硬件，从而实现应用需求。一般，嵌入式应用程序建立在主任务基础之上，可以是多任务的，通过嵌入式操作系统管理工具（信号量、队列等）实现任务间通信和管理，进而实现应用需要的特定功能。

# 1.8 嵌入式系统的设计方法

<span style="color:#000000"> __1\.8\.1 嵌入式系统的总体结构__ </span>

在不同的应用场合，嵌入式系统呈现出的外观和形式各不相同，但通过对其内部结构进行分析，可以发现，一个嵌入式系统一般都由嵌入式微处理器系统和被控对象组成。其中嵌入式微处理器系统是整个系统的核心，由硬件层、中间层、软件层和功能层组成。被控对象可以是各种传感器、电机、输入输出设备等，可以接收嵌入式微处理器系统发出的控制命令，执行所规定的操作或任务。下面对嵌入式系统的主要组成进行简单描述。

1\.	  硬件层应用层

硬件层由嵌入式微处理器、外围电路和外部设备组成。在一片嵌入式微处理器基础上增加电源电路、复位电路、调试接口和存储器电路，就构成一个嵌入式核心控制模块。其中操作系统和应用程序都可以固化在ROM或者Flash中，为方便使用，有的模块在此基础上增加了LCD、键盘、USB接口，以及其他一些功能的扩展电路和接口。

嵌入式系统的硬件层是以嵌入式处理器为核心的，最初的嵌入式处理器都是为通用目的而设计的。后来随着微电子技术的发展出现了ASIC（专用的集成电路），ASIC 是一种为具体任务而特殊设计的专用集成电路。由于ASIC在设计过程中进行了专门优化，其性能、性价比都非常高。采用ASIC可以减少系统软硬件设计的复杂度，降低系统成本。有的嵌入式微处理器利用ASIC来实现，但ASIC的前期设计费用非常高，而且ASIC一旦设计完成，就无法升级和扩展，一般只有在一些产量非常大的产品设计中才考虑使用ASIC。

2\.	  中间层

硬件层与软件层之间为中间层，也称为BSP（板级支持包），将系统软件与底层硬件部分隔离，使得系统的底层设备驱动程序与硬件无关，一般应具有相关硬件的初始化、数据的输入输出操作和硬件设备的配置等功能。BSP是主板硬件环境和操作系统的中间接口，是软件平台中具有硬件依赖性的那一部分，主要目的是为了支持操作系统，使之能够更好地运行于硬件主板上。

纯粹的BSP所包含的内容一般说来是与系统有关的驱动程序，如网络驱动程序和系统中的网络协议，串口驱动程序和系统的下载调试等。离开这些驱动程序系统就不能正常工作。

3\.  软件层中间层

软件层主要是操作系统，有的还包括文件系统、图形用户接口和网络系统等。操作系统是嵌入式应用软件的基础和开发平台，实际上是一段程序，系统复位后首先执行，相当于用户的主程序，用户的其他应用程序都建立在操作系统之上。操作系统是一个标准的内核，将中断、 IO、定时器等资源都封装起来、以方使用户使用。

操作系统的引入大大提高了嵌入式系统的功能，方便了应用软件的设计，但同时也占用了宝贵的嵌入式系统资源。一般在大型的或需要多任务的应用场合才考虑使用嵌入式操作系统。

4\.  功能层

功能层由基于操作系统开发的应用程序组成，用来完成对被控对象的控制功能。为了方便用户操作，往往需要具有友好的人机界面。

对于一些复杂的系统，在系统设计的初期阶段就要对系统的需求进行分析，确定系统功能。然后将系统的功能映射到整个系统的硬件、软件和执行装置的设计过程中，这个过程称为系统的功能实现。

嵌入式系统的应用开发是按照一定的流程进行的，一般由五个阶段构成：需求分析、体系结构设计、硬件／软件设计、系统集成和代码固化，各个阶段之间往往要求不断地重复和修改直至最终完成设计目标。

嵌入式系统开发已经逐步规范化，在遵循一般工程开发流程的基础上，必须将硬件、软件人力等各方面资源综合起来。嵌入式系统发都是软、硬件的结合体和协同开发过程，这是其最大的特点。嵌入式系统设计流程图1\-13所示。

__图__  __1\-13 __  __嵌入式系统设计流程图__

1\.  需求分析

嵌入式系统的特点决定了系统在开发初期的需求分析中就要搞清楚需要完成的任务。在此阶段需要分析系统的需求，系统的需求一般分为功能需求和非功能需求两方面。功能需求是系统的基本功能，如输入输出信号、操作方式等；非功能需求包括系统性能、成本、功耗、体积、重量等因素。

根据系统的需求，确定设计任务和设计目标，并提炼出设计规格说明书，作为正式指导设计和验收的标准。

2\.  体系结构设计

需求分析完成后，根据提炼出的设计规格说明书。进行体系结构的设计。系统的体系结构注予系统如何实现所述的功能和非功能需求。

包括对硬件、软件的功能划分，以及系统的硬件和操作系统的选型等。

3\.  软／硬件设计

基于体系结构对系统的软、硬件进行详细设计。为了缩短产品开发周期，设计往往是并行的。对于每一个处理器的硬件平台都是通用的、固定的、成熟的，在开发过程中减少了硬件系统错误的引入机会。同时，嵌入式操作系统屏蔽掉了低层硬件的很多复杂信息，开发者利用操作系统提供的API函数可以完成大部分功能。对于一个完整的嵌入式应用系统的开发，应用系统的程序设计是嵌入式系统设计一个非常重要的方面，程序的质量直接影响整个系统功能的实现，好的程序设计可以克服系统硬件设计的不足，提高应用系统的性能；反之，会使整个应用系统无法正常工作。

不同于基于PC平台的程序开发，嵌入式系统的程序设计具有其自身的特点，程序设计的方法也会因系统或人而异。

4\.  系统集成和代码固化

把系统中的软件、硬件集成在一起，进行调试，发现并改进单元设计过程中的错误。

嵌入式软件开发完成以后，大多数在目标环境的非易失性存储器中运行，程序写入到Flash固化，保证每次运行后下一次运行无误，所以嵌入式软件开发与普通软件开发相比，增加了固化阶段。嵌入式应用软件调试完成以后，编译器要对源代码重新编译一次，以产生固化到环境的可执行代码，再烧写到Flash。可执行代码烧写到目标环境中固化后，整个嵌入式系统的开发就基本完成了，剩下的就是对产品的维护和更新了。

# 1.8.3 嵌入式系统的软／硬件协同设计技术

传统的嵌入式系统设计方法，硬件和软件分为两个独立的部分，由硬件工程师和软件工程师按照拟定的设计流程分别完成。这种设计方法只能改善硬件／软件各自的性能，而有限的设计空间不可能对系统做出较好的性能综合优化。从理论上来说，每一个应用系统，都存在一个适合该系统的硬件、软件功能的最佳组合，如何从应用系统需求出发，依据一定的指导原则和分配算法对硬件／软件功能进行分析及合理的划分，从而使系统的整体性能、运行时间、能量耗损、存储能量达到最佳状态，已成为软／硬件协同设计的重要研究内容之一。

系统协同设计与传统设计相比有两个显著的区别：

（1）描述硬件和软件使用统一的表示形式；

（2）软／硬件划分可以选择多种方案，直到满足要求。

显然，这种设计方法对于具体的应用系统而言，容易获得满足综合性能指标的最佳解决方案。传统方法虽然也可改进软／硬件性能，但由于这种改进是各自独立进行的，不一定使系统综合性能达到最佳。

传统的嵌入式系统开发采用的是软件开发与硬件开发分离的方式，其过程可描述如下：

（1）需求分析；

（2）软／硬件分别设计、开发、调试、测试；

（3）系统集成；

（4）集成测试；

（5）若系统正确，则结束，否则继续进行；

（6）若出现错误，需要对软／硬件分别验证和修改；返回（3），再继续进行集成测试。

虽然在系统设计的初始阶段考虑了软／硬件的接口问题，但由于软、硬件分别开发，各自部分的修改和缺陷很容易导致系统集成出现错误。由于设计方法的限制，这些错误不但难以定位，而且更重要的是，对它们的修改往往会涉及整个软件结构或硬件配置的改动。显然，这是灾难性的。

软/硬件协同设计过程可归纳为:

（1）需求分析；

（2）软/硬件协同设计；

（3）软/硬件实现；

（4）软/硬件协同测试和验证。

这种方法的特点是在协同设计、协同测试和协同验证上，充分考虑了软／硬件的关系，并在设计的每个层次上给以测试验证，使得尽早发现和解决问题，避免灾难性错误的出现。

# 1.9 嵌入式系统的发展

<span style="color:#000000">1\.9\.1 </span>  <span style="color:#000000">嵌入式系统的发展历程</span>

从20世纪70年代单片机出现到今天。嵌入式系统已经历了40余年的发展。一般认为，嵌入式系统的发展主要经历了以下四个阶段。

1\.	  以单板机为核心的嵌入式系统阶段

早期的嵌入式系统起源于20世纪70年代的微型计算机，然而微型计算机的体积、价格、可靠性都难以满足特定的嵌入式应用要求。到了80年代后，集成电路技术的出现，极大地缩小了计算机的体积，使其向微型化方向发展。整个微型计算机系统中的CPU、内存、存储器和申行／并行端口等芯片可以放在单个电路板上，用印制电路将各个功能芯片连接起来，构成一台单板计算机，简称“单板机”（Single Board Computer，SBC）。这一阶段的嵌人式系统虽然较微型计算机体积有所缩小，但依然难以嵌入普通家用电器产品中，同时价格相对较高，主要还是应用于工业控制领域。

2\.	  以单片机为核心的嵌入式系统阶段

到了20世纪80年代，随着微电子工艺水平的提高，Intel和Philips 等集成电路制造商开始寻求单片形态嵌入式系统的最佳体系结构。把嵌入式应用中所需要的微处理器、I/O接口、A/D转换、D/A转换、串行接口以及RAM、ROM等部件统统集成到一个大规模集成电路（VLSI）中，制造出了面向I/O设计的微控制器，也就是单片计算机，简称“单片机”。单片机伴随后来DSP的出现进一步提升了嵌入式计算机系统的技术水平。在单片机出现后的一段时期，嵌入式应用软件通常采用汇编语言编写，对系统进行直接控制，之后开始出现了一些简单的“嵌入式操作系统”。这一阶段的嵌入式系统已从工业控制领域开始迅速渗透到仪器仪表、通信电子、医用电子、交通运输、家用电器等诸多领域。

3\.	 以多类嵌入式处理器和嵌入式操作系统为核心的嵌入式系统阶段

到了20世纪90年代，在分布式控制、柔性制造、数字化通信和消费电子等巨大需求的牵引下，嵌入式系统进一步加速发展，以PowerPC、Arm、MIPS等为代表的8位、16位、32位各种不同类型的高性能、低功耗的嵌入式处理器不断涌现。随着嵌入式应用对实时性要求的提高，嵌入式系统的软件也伴随硬件实时性的提高不断扩大其规模，逐渐形成了多任务的实时操作系统（RTOS）。这些操作系统不但能够运行在各种不同类型的嵌入式微处理器上，而且具备了文件管理、设备管理、多任务、网络、图形用户界面（GUI）等功能，还提供了大量的应用程序接口（API），具有实时性好、模块化程度高、可裁剪和可扩展等特点，从而使应用软件的开发变得更加简单和高效。

4\.	  面向互联网的嵌入式系统阶段

21世纪以来，人类真正进入了互联网时代。在硬件上，随着微电子技术、通信技术、IC设计技术、EDA技术的迅猛发展，相继出现了品类繁多的32位、64位嵌入式处理器，特别是在Arm Cortex 系列内核架构发布以后，各种各样以Arm Cortex 内核设计生产的MPU、MCU、SoC 如雨后春笋般不断涌现。这些嵌入式处理器内存容量足够大，I/O 功能足够丰富。其扩展方式从并行总线接口发展出了各种串行总线接口，形成了一系列的工业标准，如IC总线接口、SPI总线接口、USB接口、以太网接口、CAN接口等。甚至将网络协议的低两层或低三层都集成到了嵌入式处理器中，促使各种各样的嵌入式设备具备了接入互联网的能力，不但具有 Ethernet/CAN/USB 有线网络和ZigBee/NFC/RFID/Wi\-Fi/Bluetooth/Lora 等近场无线通信功能，而且具有GPRS/3G/4G/NB\-IoT的公共网络无线通信功能。软件上，嵌入式实时操作系统也纷纷添加了支持各种

网络通信的协议栈，提供了支持各种通信功能的API，转型为物联网实时操作系统。目前越来越多的嵌入式系统产品和设备接入了互联网，在云计算技术的支持下，嵌入式系统通过云平台不但可以实现与人的交互，也可实现与其他嵌入式系统的交互，开启了嵌入式系统的万物互联时代。随着Internet技术与信息家电、工业控制、航空航天等技术的结合日益密切，嵌入式设备与Internet的融合也更加深入。

# 1.9.2 嵌入式系统的发展趋势

嵌入式系统自诞生以来已经走过了漫长的道路，如今世界上99％的计算机系统都被认为是嵌入式系统。随着物联网技术、人工智能技术以及5G通信等新技术的快速发展以及各种创新应用形态的不断出现，嵌入式系统技术已成为智能和互联物联网生态快速发展的推动者。那么，接下来的几年嵌入式系统会朝着哪些方向发展呢？以下是对嵌入式系统今后一段时期发展趋势的一些思考。

1\.	  更智能嵌入式人工智能

目前，我们周围已经能够见到多种多样的嵌入式智能设备，如智能手机、智能音箱、机器人、城市天眼系统、智能家居产品等。这些智能设备一般都可以通过语音识别、图像识别、生物特征识别、自然语言合成等技术实现与人的交互。但从现实体验看，目前的智能水平还不够高，还有发展空间。

2\.	更实时的连接－嵌入式系统与5G技术的融合

4G通信的时延无法满足严苛的物联网应用中的实时性、安全性要求，成为物联网应用的技术瓶颈。5G的诞生带来了低时延、高可靠和低功耗的信息传输技术，能够有效突破上述技术瓶颈。例如，在工业生产中，利用5G网络建立前端嵌入式系统设备与后端监控系统之间的低时延、高可靠通信连接，这对于有效监控生产流程和提高生产效率具有重大意义。又如，日常生活中的智能穿戴产品、智能家居、智能医疗、智能安防以及智能汽车等，通过5G连接，可以使每个嵌入式终端设备都能够自由连通，数据实时共享，孕育出更加丰富和更加灵活的应用模式。同时，5G也将有助于产生一个由嵌入式SoC架构支持的全新生态系统，推动嵌入式处理器和嵌入式操作系统的技术升级。对于嵌入式系统而言，在5G时代，无论设备大小、功能强弱，都需要带有联网功能，因此现在正在使用的产品可能需要大批量进行更新换代，这样便会触发嵌入式产品的新一波巨大需求。因此，嵌入式系统与5G技术的融合正在成为嵌入式系统发展的一个趋势。

3\.	更安全——嵌入式系统安全

随着嵌入式系统应用的日益广泛，连接互联网的嵌入式设备越来越多，嵌入式系统的安全性和隐私保护问题也变得越发重要。

嵌入式系统设备旨在执行一个或一组指定的任务，这些设备通常设计为最小化处理周期并减少存储器的使用，由于资源有限，为通用计算机开发的安全解决方案无法在嵌入式设备中使用。因此在嵌入式系统的设计过程中如何考虑设备安全性、数据安全性和通信安全性，成为一个新的挑战，需要思考诸多问题。开发阶段，如何确保代码的真实性和不可更改性；在设备部署阶段，如何建立一种信任机制，既要防止不受信任的二进制文件运行，又要确保正确的软件在正确的硬件上运行；在设备运行期间，如何防止未

授权的控制访问，以及保证数据在网络传输时不被窃取；当设备处于停机状态时，如何防止设备上的数据不被非法访问等，这些都是保证嵌入式系统安全性必须解决的关键问题。目前，包括区块链技术的多种安全新技术融入嵌入式系统应用中，将促使嵌入式系统在其整个生命周期中更加安全。

4\.	更丰富的形态——嵌入式系统虚拟化

虚拟化起源于大型计算机，随后在服务器中得到了极大的发展和应用。如今，虚拟化也正在进入嵌入式系统设备中。嵌入式应用需求推动着嵌入式系统变得更大、更复杂，这本身与嵌入式系统的设计初衷相矛盾，因此人们越来越希望对系统进行高度整合，以期减少系统的体积、重量、功耗以及系统的整体成本，将虚拟化技术引入嵌入式系统也就成为一种新的选择。许多嵌入式应用期待能够在单个硬件上运行多个应用程序的操作环境，这就需要一个像虚拟机管理程序这样的支持层。它可以虚拟化出多个嵌入式操作系统，并依靠使用公共的嵌入式硬件资源高效地运行这些操作系统，同时还要确保各个操作系统之间不会相互干扰。

与传统的虚拟机管理程序不同，嵌入式虚拟机管理程序实现了一种不同的抽象。它需要具有极高的内存使用效率、更灵活的通信方法，还需要针对不同嵌入式软件既共存又相互隔离的环境，同时还需要具备实时调度的能力。

嵌入式系统虚拟化增加了系统的灵活性，提供了更多和更高级别的功能，使嵌入式设备变成了一种新的嵌入式系统类别。目前，已经出现了一些用于嵌入式系统虚拟化的工具，如VMware Mobile Virtualization Platform、PikeOS、OKL4、NOVA、Codezero等。2020年9月，华为公司发布了全球首个基于Arm 芯片的“云手机”，成为“华为云＋5G网＋显示屏”三位一体的全新嵌入式设备，也预示着嵌入式系统与虚拟化的融合将向更深层次发展。

